'use strict';
angular.module("m-grid",["m-grid.config","m-grid.directive","m-grid.service","m-grid.pagination","m-grid.start-from.filter","m-grid.progress-circular.direcitve"]),angular.module("m-grid.config",[]).constant("mGridConfig",{tableClass:"table table-striped table-bordered m-grid-table",thClass:"m-grid-th",footerClass:"m-grid-footer",displayLimitOptions:[{text:10,value:10},{text:20,value:20},{text:50,value:50},{text:100,value:100}]}),angular.module("m-grid.directive",["m-grid.config"]).directive("mGrid",["$log","$compile","$filter","$timeout","$http","$q","mGridConfig","mGridService",function(t,a,e,i,n,r,o,l){return{scope:{gridOptions:"="},replace:!0,restrict:"E",template:'<div class="m-grid"></div>',link:function(s,g,d){if(!s.gridOptions)throw new Error("mGrid must configure gridOptions and there columns");var c,u,p,m=s.gridOptions.globalSearch||o.globalSearch||"globalSearch",f=!1,h=10;if(s.predicate="",s.reverse=!1,s.displayLimitOptions=o.displayLimitOptions,s.startFrom=0,s.currentPage=1,s.displayLimit=10,s.gridData={data:[],total:0,loading:!1,loadingFull:!1,firstLoaded:!1},s.gridOptions.enableSearch){u=s.$on(m,function(t,a){P(a)});var v=s.$watch("gridOptions.search",function(t,a){P(t)})}var y=s.$watch("displayLimit",function(){s.gridData.loadingFull=!1,f&&h!==s.displayLimit&&(h=s.displayLimit,w())});s.$on("$destroy",function(){s.gridOptions.enableSearch&&(u(),v()),y()}),function(){var t=l.getGridTemplate(s.gridOptions,o);g.html(t),a(g.contents())(s)}(),s.getExternalScope=function(){return s.$parent[s.gridOptions.externalScope||"states"]||{}},s.order=function(t,a){a&&(s.reverse=s.predicate===t&&!s.reverse,s.predicate=t,s.currentPage=1,s.currentPageChange())},s.getRecordCount=function(){if(s.gridOptions.async)return s.gridData.total||0;var t=s.gridOptions.data||[];return!0===s.gridOptions.enableSearch&&(t=O(t,s.search)),t.length},s.getData=function(){if(s.gridOptions.async)return s.gridData.data||[];var t=s.gridOptions.data||[];return!0===s.gridOptions.enableSearch&&(t=O(t,s.search)),s.predicate&&(t=D(t,s.predicate,s.reverse)),!0!==s.gridOptions.disablePagination&&(t=b(t,s.startFrom),t=x(t,s.displayLimit)),t},s.currentPageChange=function(){if(s.startFrom=(s.currentPage-1)*s.displayLimit,f&&s.gridOptions.async){s.gridData.loadingFull=!1,s.gridData.loading=!0;var a=C();s.asyncData(a).then(function(t){s.gridData.data=s.gridOptions.data=t,s.gridData.loading=!1,s.gridData.firstLoaded=!0,S()},function(a){s.gridData.loading=!1,s.gridData.firstLoaded=!0,t.error(a)})}},s.getStatusString=function(){var t=s.getRecordCount();return s.startFrom+1+" - "+Math.min(s.startFrom+s.displayLimit,t)+" of "+t+" items"},s.recompile=function(t){if(t){var e=l.getGridTemplate(s.gridOptions,o);g.html(e),a(g.contents())(s)}else{var i=g.find("tbody");i.html(l.getBodyTemplate(s.gridOptions,o)),a(i.contents())(s)}};var P=function(t){i.cancel(c),c=i(function(){s.search!==t&&(s.search=t,s.gridOptions.async&&w())},1e3)},D=function(t,a,i){return e("orderBy")(t,a,i)},b=function(t,a){return e("mGridStartFrom")(t,a)},x=function(t,a){return e("limitTo")(t,a)},O=function(t,a){return e("filter")(t,a)},$=function(t){return function(a){var e=t;return angular.forEach(a,function(t,a){angular.isUndefined(t)&&(t=""),e=e.replace("{"+a+"}",t)}),n.get(e).then(function(t){return t.data}).catch(function(t){return r.reject(t.data)})}},C=function(){var t="";s.predicate&&(t=(s.reverse?"-":"")+s.predicate);var a={};if(s.gridOptions.urlParams&&angular.isObject(s.gridOptions.urlParams))for(var e in s.gridOptions.urlParams)a[e]=s.gridOptions.urlParams[e];return angular.extend(a,{term:s.search,orderby:t,skip:s.startFrom,take:s.displayLimit,page:s.currentPage,limit:s.displayLimit}),a},w=function(){s.currentPage=1;var a=C();s.gridData.loading=!0,s.gridData.loadingFull=!0,s.asyncDataCount(a).then(function(e){s.gridData.total=e,S(),s.asyncData(a).then(function(t){s.gridData.data=s.gridOptions.data=t,s.gridData.loading=!1,s.gridData.firstLoaded=!0,s.gridData.loadingFull=!1,S()},function(a){s.gridData.loading=!1,s.gridData.firstLoaded=!0,s.gridData.loadingFull=!1,t.error(a)})},function(a){s.gridData.loading=!1,s.gridData.loadingFull=!1,t.error(a)})},S=function(){void 0===p&&(p=i(function(){p=void 0,s.$$phase?S():s.$apply()},500))};if(s.gridOptions.refresh=s.recompile,s.gridOptions.defaultSorting){var L=s.gridOptions.defaultSorting;0===L.indexOf("-")&&(L=L.substring(1),s.predicate=L),s.order(L,!0)}s.gridOptions.async&&(function(){if("function"!=typeof s.gridOptions.asyncData&&"string"!=typeof s.gridOptions.asyncData||"function"!=typeof s.gridOptions.asyncDataCount&&"string"!=typeof s.gridOptions.asyncDataCount)throw new Error("asyncData and asyncCount must a function or string");"function"==typeof s.gridOptions.asyncData?s.asyncData=s.gridOptions.asyncData:s.asyncData=$(s.gridOptions.asyncData),"function"==typeof s.gridOptions.asyncDataCount?s.asyncDataCount=s.gridOptions.asyncDataCount:s.asyncDataCount=$(s.gridOptions.asyncDataCount)}(),w()),f=!0}}}]),angular.module("m-grid.pagination",["m-grid.config"]).factory("mGridPaging",["$parse",function(t){return{create:function(a,e,i){a.setNumPages=i.numPages?t(i.numPages).assign:angular.noop,a.ngModelCtrl={$setViewValue:angular.noop},a._watchers=[],a.init=function(t,n){a.ngModelCtrl=t,a.config=n,t.$render=function(){a.render()},i.itemsPerPage?a._watchers.push(e.$parent.$watch(i.itemsPerPage,function(t){a.itemsPerPage=parseInt(t,10),e.totalPages=a.calculateTotalPages(),a.updatePage()})):a.itemsPerPage=n.itemsPerPage,e.$watch("totalItems",function(t,i){(angular.isDefined(t)||t!==i)&&(e.totalPages=a.calculateTotalPages(),a.updatePage())})},a.calculateTotalPages=function(){var t=a.itemsPerPage<1?1:Math.ceil(e.totalItems/a.itemsPerPage);return Math.max(t||0,1)},a.render=function(){e.page=parseInt(a.ngModelCtrl.$viewValue,10)||1},e.selectPage=function(t,i){i&&i.preventDefault(),(!e.ngDisabled||!i)&&e.page!==t&&t>0&&t<=e.totalPages&&(i&&i.target&&i.target.blur(),a.ngModelCtrl.$setViewValue(t),a.ngModelCtrl.$render())},e.noPrevious=function(){return 1===e.page},e.noNext=function(){return e.page===e.totalPages},a.updatePage=function(){a.setNumPages(e.$parent,e.totalPages),e.page>e.totalPages?e.selectPage(e.totalPages):a.ngModelCtrl.$render()},e.$on("$destroy",function(){for(;a._watchers.length;)a._watchers.shift()()})}}}]).directive("mGridTabindexToggle",function(){return{restrict:"A",link:function(t,a,e){e.$observe("disabled",function(t){e.$set("tabindex",t?-1:null)})}}}).constant("mGridPaginationConfig",{itemsPerPage:10,maxSize:5}).controller("mGridPaginationController",["$scope","$attrs","$parse","mGridPaging","mGridPaginationConfig",function(t,a,e,i,n){function r(t,a,e){return{number:t,text:a,active:e}}function o(t,a){var e=[],i=1,n=a,o=angular.isDefined(s)&&s<a;o&&(i=(Math.ceil(t/s)-1)*s+1,n=Math.min(i+s-1,a));for(var l=i;l<=n;l++){var d=r(l,g(l),l===t);e.push(d)}if(o&&s>0){if(i>1){var c=r(i-1,"...",!1);e.unshift(c)}if(n<a){var u=r(n+1,"...",!1);e.push(u)}}return e}var l=this,s=angular.isDefined(a.maxSize)?t.$parent.$eval(a.maxSize):n.maxSize,g=angular.identity;a.$set("role","menu"),i.create(this,t,a),a.maxSize&&l._watchers.push(t.$parent.$watch(e(a.maxSize),function(t){s=parseInt(t,10),l.render()}));var d=this.render;this.render=function(){d(),t.page>0&&t.page<=t.totalPages&&(t.pages=o(t.page,t.totalPages))}}]).directive("mGridPagination",["$log","$parse","mGridPaginationConfig",function(t,a,e){return{scope:{totalItems:"=",ngDisabled:"="},require:["mGridPagination","?ngModel"],restrict:"E",replace:!0,controller:"mGridPaginationController",controllerAs:"pagination",template:'<ul class="pagination pagination-sm" style="margin: 0px;"><li role="menuitem" ng-class="{disabled: noPrevious()||ngDisabled}" class="pagination-first"><a href ng-click="selectPage(1, $event)" ng-disabled="noPrevious()||ngDisabled" m-grid-tabindex-toggle>First</a></li><li role="menuitem" ng-repeat="page in pages track by $index" ng-class="{active: page.active,disabled: ngDisabled&&!page.active}" class="pagination-page"><a href ng-click="selectPage(page.number, $event)" ng-disabled="ngDisabled&&!page.active" m-grid-tabindex-toggle>{{page.text}}</a></li><li role="menuiem" ng-class="{disabled: noNext()||ngDisabled}" class="pagination-last"><a href ng-click="selectPage(totalPages, $event)" ng-disabled="noNext()||ngDisabled" m-grid-tabindex-toggle>Last</a></li></ul>',link:function(t,a,i,n){a.addClass("pagination");var r=n[0],o=n[1];o&&r.init(o,e)}}}]),angular.module("m-grid.service",[]).service("mGridService",["$log",function(t){function a(t,a){var e="";if(t.style){var i=t.style;e=" ng-style=\"{'text-align':'"+(i.textAlign||"left")+"','display':"+(!1!==i.visible?"'table-cell'":"'none'")+'}"'}var n="<td"+e+">";return t.cellTemplate?n+=a?'<div ng-init="'+a+'=item">'+t.cellTemplate+"</div>":"<div>"+t.cellTemplate+"</div>":n+="<span ng-bind=\"item['"+t.field+"']"+(t.format?" | "+t.format:"")+'"></span>',n+="</td>"}function e(t,e){var i="";return i+='<tr ng-repeat="item in getData()">',angular.forEach(t.columns,function(e){i+=a(e,t.rowItemAlias)}),i+="</tr>",i+='<tr ng-show="getRecordCount() == 0 && (!gridOptions.async || gridData.firstLoaded)"><td colspan="'+t.columns.length+'"><div style="text-align:center; margin: 20px auto 20px;"><h3>No record found</h3></div></td></tr>'}function i(t,a){var e="";return e+='<div ng-hide="getRecordCount() == 0 || (gridData.loading && gridData.loadingFull)" class="panel-footer '+a.footerClass+'">',e+='<m-grid-pagination class="pull-left" style="margin: 0px;" total-items="getRecordCount()" max-size="3" ng-model="currentPage" items-per-page="displayLimit" rotate="false" ng-change="currentPageChange()"></m-grid-pagination>',e+='<div class="pull-left" style=" margin-left: 10px;">',e+='<select class="form-control input-sm hidden-xs" style="display:inline-block; width: 70px; height: 29px;" type="text" ng-model="displayLimit" ng-options="o.value as o.text for o in displayLimitOptions"></select>',e+='<span class="hidden-xs"> items per page</span>',e+='<span ng-if="gridData.loading && !gridData.loadingFull && gridData.firstLoaded" style="display:inline-block; vertical-align: middle; margin-left: 10px; height:22px;">',e+='<progress-circular size="sm"></progress-circular>',e+="</span>",e+="</div>",e+='<div class="pull-right hidden-xs" ng-bind="getStatusString()" style="margin-top:5px;"></div>',e+='<div class="clearfix"></div>',e+="</div>"}return{getGridTemplate:function(t,a){var n="";return n+='<div style="overflow-x:auto;width: 100%;">',n+='<table class="'+a.tableClass+'">',n+="<thead>",n+="<tr>",n+='<th ng-repeat="column in gridOptions.columns" class="'+a.thClass+"\" ng-style=\"{'width':column.style.width||'auto','min-width':column.style.minWidth||'auto','text-align':column.style.textAlign||'left','display':(column.style.visible!==false?'table-cell':'none')}\">",n+='<a href="" ng-click="order(column.field, (column.sorting !== undefined ? column.sorting : gridOptions.sorting))" ng-bind="column.name">Name</a>',n+='<span class="m-grid-sortorder" ng-show="predicate === column.field" ng-class="{\'m-grid-sortorder-reverse\':reverse}"></span>',n+="</th>",n+="</tr>",n+="</thead>",n+='<tbody ng-hide="gridData.loading && gridData.loadingFull">',n+=e(t),n+="</tbody>",n+="<tbody>",n+='<tr ng-show="gridOptions.async && ((gridData.loading && gridData.loadingFull) || !gridData.firstLoaded)"><td colspan="'+t.columns.length+'" style="text-align:center; margin: 20px auto 10px;"><progress-circular></progress-circular></td></tr>',n+="</tbody>",n+="</table>",!0!==t.disablePagination&&(n+=i(0,a)),n+="</div>"},getCellTemplate:a,getBodyTemplate:e,getPaginationTemplate:i}}]),angular.module("m-grid.start-from.filter",[]).filter("mGridStartFrom",function(){return function(t,a){return angular.isArray(t)?(a=+a,t.slice(a)):t}});